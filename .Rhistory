ggplot(aes(x = n, y = mse, color = model, fill = model)) +
geom_boxplot(alpha = 0.7) +
facet_wrap(~scenario, nrow = 2) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
labs(y = "MSE",
x = "Sample size")
# MSE
res_bin %>%
filter(mse < 0.5) %>%
ggplot(aes(x = n, y = mse, color = model, fill = model)) +
geom_boxplot(alpha = 0.7) +
facet_wrap(~scenario, nrow = 2) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
labs(y = "MSE",
x = "Sample size")
# Correlation
res_bin %>%
filter(scenario != "Null") %>%
ggplot(aes(x = n, y = corr, color = model, fill = model)) +
geom_boxplot(alpha = 0.7) +
facet_wrap(~scenario) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
labs(y = expression("Pearson's " * rho),
x = "Sample size")
# correct tests
res_bin %>%
group_by(scenario, n, model) %>%
summarise(across(c(BLP_correct, indep_correct), mean), .groups = "drop") %>%
pivot_longer(
cols = c(BLP_correct, indep_correct),
names_to = "Metric",
values_to = "Proportion"
) %>%
ggplot(aes(x = n, y = Proportion, color = model, fill = model)) +
geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
facet_grid(rows = vars(Metric), cols = vars(scenario)) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
labs(title = "proportion of correct BLP tests",
y = "proportion of simulations",
x = "Sample size")
res_bin %>%
ggplot(aes(x = BLP_p, y = model, color = model, fill = model, group = interaction(n, scenario, model))) +
geom_density_ridges(alpha = 0.5) +
facet_grid(rows = vars(n), cols = vars(scenario)) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
xlim(0,1) +
labs(title = "P-value distribution from BLP test",
x = "p-value",
y = "Sample size")
View(missing_ids_by_sample_size)
knitr::opts_chunk$set(echo = TRUE)
ci_length <- readRDS("/rds/general/user/evanvogt/projects/nihr_drf_simulations/live/results/binary/all/ci_length.RDS")
coverage_df  <- create_summary_df(cate_coverage, "coverage")
create_summary_df <- function(nested_list, summary_name = "coverage") {
map_dfr(names(nested_list), function(scenario) {
map_dfr(names(nested_list[[scenario]]), function(n) {
map_dfr(names(nested_list[[scenario]][[n]]), function(model) {
df <- data.frame(
scenario = as.numeric(gsub("scenario_", "", scenario)),
n = as.factor(n),
model = model
)
df[[summary_name]] <- mean(nested_list[[scenario]][[n]][[model]])
df$mcse <- sd(nested_list[[scenario]][[n]][[model]])/sqrt(1000)
df <- df %>% mutate(
lb = df[[summary_name]] + qnorm(0.025)*mcse,
ub = df[[summary_name]] + qnorm(0.975)*mcse
)
df <- df %>% arrange(scenario)
df
})
})
})
}
plot_all <- function(df, bench, var, title) {
ggplot(df, aes(x = model, y = .data[[var]], colour = model)) +
geom_point() +
geom_segment(aes(x = model, xend = model, y = bench, yend = .data[[var]])) +
facet_grid(n ~ scenario) +
theme_minimal() +
theme(
axis.title.x = element_blank(),
axis.text.x = element_blank(),
axis.ticks.x = element_blank()
) +
labs(
title = title,
x = "Model",
y = var
)
}
plot_all_scenario <- function(df, bench, var, title) {
scenario_plots <- lapply(unique(df$scenario), function(scenario) {
p <- ggplot(df[df$scenario == scenario, ], aes(x = model, y = .data[[var]], colour = model)) +
geom_point() +
geom_segment(aes(x = model, xend = model, y = bench, yend = .data[[var]])) +
facet_wrap(~ n) +  # Facet by sample size
theme_minimal() +
theme(
axis.title.x = element_blank(),
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
axis.ticks.x = element_blank()
) +
labs(
title = paste(title, "-", scenario),
x = "Model",
y = var
)
return(p)
})
names(scenario_plots) <- unique(df$scenario)  # Name list elements by scenario
return(scenario_plots)
}
plot_MCSE <- function(df, var, title) {
ggplot(df, aes(x = model, y = .data[[var]], colour = model)) +
geom_point() +
geom_segment(aes(x = model, xend = model, y = lb, yend = ub)) +
facet_grid(n ~ scenario) +
theme_minimal() +
theme(
axis.title.x = element_blank(),
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
axis.ticks.x = element_blank()
) +
labs(
title = title,
x = "Model",
y = var
)
}
plot_MCSE_scenario <- function(df, var, title) {
scenario_plots <- lapply(unique(df$scenario), function(scenario) {
p <- ggplot(df[df$scenario == scenario, ], aes(x = model, y = .data[[var]], colour = model)) +
geom_point() +
geom_segment(aes(x = model, xend = model, y = lb, yend = ub)) +
facet_wrap(~ n) +  # Facet by sample size instead of scenario
theme_minimal() +
theme(
axis.title.x = element_blank(),
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
axis.ticks.x = element_blank()
) +
labs(
title = paste(title, "-", scenario),
x = "Model",
y = var
)
return(p)
})
names(scenario_plots) <- unique(df$scenario)  # Name list elements by scenario
return(scenario_plots)
}
coverage_df  <- create_summary_df(cate_coverage, "coverage")
cate_coverage <- readRDS("/rds/general/user/evanvogt/projects/nihr_drf_simulations/live/results/binary/all/cate_coverage.RDS")
coverage_df  <- create_summary_df(cate_coverage, "coverage")
ci_df <- create_summary_df(ci_length, "length")
# Combine into one tidy data frame for easier plotting/analysis
ci_df <- bind_rows(
lapply(names(ci_length), function(scn) {
lapply(names(ci_length[[scn]]), function(sz) {
lapply(names(ci_length[[scn]][[sz]]), function(mod) {
ci_length[[scn]][[sz]][[mod]]
}) %>% bind_rows()
}) %>% bind_rows()
}) %>% bind_rows()
)
rlang::last_trace()
names(ci_length)
test <- lapply(names(ci_length[["scenario_1"]][["250"]]) function(model) { ci_length[["scenario_1"]][["250"]][[mod]]}) %>% bind_rows()
test <- lapply(names(ci_length[["scenario_1"]][["250"]]), function(model) { ci_length[["scenario_1"]][["250"]][[mod]]}) %>% bind_rows()
test <- lapply(names(ci_length[["scenario_1"]][["250"]]), function(mod) { ci_length[["scenario_1"]][["250"]][[mod]]}) %>% bind_rows()
class(ci_length[["scenario_1"]][["250"]][["CF"]])
test <- ci_length[["scenario_1"]][["250"]][["CF"]]
class(test)
# Combine into one tidy data frame for easier plotting/analysis
ci_df <- bind_rows(
lapply(names(ci_length), function(scn) {
lapply(names(ci_length[[scn]]), function(sz) {
lapply(names(ci_length[[scn]][[sz]]), function(mod) {
mod <- ci_length[[scn]][[sz]][[mod]]
}) %>% bind_rows()
}) %>% bind_rows()
}) %>% bind_rows()
)
# Combine into one tidy data frame for easier plotting/analysis
ci_df <- bind_rows(
lapply(names(ci_length), function(scn) {
lapply(names(ci_length[[scn]]), function(sz) {
lapply(names(ci_length[[scn]][[sz]]), function(mod) {
mod <- as.vector(ci_length[[scn]][[sz]][[mod]])
}) %>% bind_rows()
}) %>% bind_rows()
}) %>% bind_rows()
)
rlang::last_trace()
# Combine into one tidy data frame for easier plotting/analysis
ci_df <- bind_rows(
lapply(names(ci_length), function(scn) {
lapply(names(ci_length[[scn]]), function(sz) {
lapply(names(ci_length[[scn]][[sz]]), function(mod_name) {
data.frame(
scenario = scn,
size = sz,
model = mod_name,
value = as.vector(ci_length[[scn]][[sz]][[mod_name]])
)
}) %>% bind_rows()
}) %>% bind_rows()
}) %>% bind_rows()
)
View(ci_df)
res_ci <- ci_df %>%
filter(scenario %in% paste0("scenario_", c(1, 3, 8, 9))) %>%
mutate(
scenario = factor(
recode(scenario,
`scenario_1` = "Null",
`scenario_3` = "Simple",
`scenario_8` = "Complex",
`scenario_9` = "Non-linear"),
levels = c("Null", "Simple", "Complex", "Non-linear")
)
)
table(ci_df$size)
table(ci_df$model)
res_ci <- ci_df %>%
filter(scenario %in% paste0("scenario_", c(1, 3, 8, 9))) %>%
filter(model != "T-RF")
res_ci <- ci_df %>%
filter(scenario %in% paste0("scenario_", c(1, 3, 8, 9))) %>%
filter(model != "T-RF") %>%
mutate(
scenario = factor(
recode(scenario,
`scenario_1` = "Null",
`scenario_3` = "Simple",
`scenario_8` = "Complex",
`scenario_9` = "Non-linear"),
levels = c("Null", "Simple", "Complex", "Non-linear")
),
n = factor(
recode(size,
`250` = "250",
`500` = "500",
`1000` = "1000"),
levels = c("250", "500", "1000")
),
model = factor(
recode(model,
`CF` = "Causal forest",
`DR_RF` = "DR-RandomForest",
`DR_oracle` = "DR-oracle"),
levels = c("Causal forest", "DR-RandomForest", "DR-oracle")
)
)
colnames(res_ci)
# Combine into one tidy data frame for easier plotting/analysis
ci_df <- bind_rows(
lapply(names(ci_length), function(scn) {
lapply(names(ci_length[[scn]]), function(sz) {
lapply(names(ci_length[[scn]][[sz]]), function(mod_name) {
data.frame(
scenario = scn,
size = sz,
model = mod_name,
length = as.vector(ci_length[[scn]][[sz]][[mod_name]])
)
}) %>% bind_rows()
}) %>% bind_rows()
}) %>% bind_rows()
)
res_ci <- ci_df %>%
filter(scenario %in% paste0("scenario_", c(1, 3, 8, 9))) %>%
filter(model != "T-RF") %>%
mutate(
scenario = factor(
recode(scenario,
`scenario_1` = "Null",
`scenario_3` = "Simple",
`scenario_8` = "Complex",
`scenario_9` = "Non-linear"),
levels = c("Null", "Simple", "Complex", "Non-linear")
),
n = factor(
recode(size,
`250` = "250",
`500` = "500",
`1000` = "1000"),
levels = c("250", "500", "1000")
),
model = factor(
recode(model,
`CF` = "Causal forest",
`DR_RF` = "DR-RandomForest",
`DR_oracle` = "DR-oracle"),
levels = c("Causal forest", "DR-RandomForest", "DR-oracle")
)
) %>%
select(-size)
res_ci %>%
ggplot(aes(x = n, y = length, color = model, fill = model)) +
geom_boxplot(alpha = 0.7) +
facet_wrap(~scenario, nrow = 2) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
labs(y = "CI length",
x = "Sample size")
# Combine into one tidy data frame for easier plotting/analysis
ci_df <- bind_rows(
lapply(names(ci_length), function(scn) {
lapply(names(ci_length[[scn]]), function(sz) {
lapply(names(ci_length[[scn]][[sz]]), function(mod_name) {
data.frame(
scenario = scn,
size = sz,
model = mod_name,
length = as.vector(ci_length[[scn]][[sz]][[mod_name]])
)
}) %>% bind_rows()
}) %>% bind_rows()
}) %>% bind_rows()
)
table(ci_df$model)
res_ci <- ci_df %>%
filter(scenario %in% paste0("scenario_", c(1, 3, 8, 9))) %>%
filter(model != "T_RF") %>%
mutate(
scenario = factor(
recode(scenario,
`scenario_1` = "Null",
`scenario_3` = "Simple",
`scenario_8` = "Complex",
`scenario_9` = "Non-linear"),
levels = c("Null", "Simple", "Complex", "Non-linear")
),
n = factor(
recode(size,
`250` = "250",
`500` = "500",
`1000` = "1000"),
levels = c("250", "500", "1000")
),
model = factor(
recode(model,
`CF` = "Causal forest",
`DR_RF` = "DR-RandomForest",
`DR_oracle` = "DR-oracle"),
levels = c("Causal forest", "DR-RandomForest", "DR-oracle")
)
) %>%
select(-size)
res_ci %>%
ggplot(aes(x = n, y = length, color = model, fill = model)) +
geom_boxplot(alpha = 0.7) +
facet_wrap(~scenario, nrow = 2) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
labs(y = "CI length",
x = "Sample size")
#####################
coverage_df <- bind_rows(
lapply(names(cate_coverage), function(scn) {
lapply(names(cate_coverage[[scn]]), function(sz) {
lapply(names(cate_coverage[[scn]][[sz]]), function(mod_name) {
data.frame(
scenario = scn,
size = sz,
model = mod_name,
length = as.vector(cate_coverage[[scn]][[sz]][[mod_name]])
)
}) %>% bind_rows()
}) %>% bind_rows()
}) %>% bind_rows()
)
res_coverage <- coverage_df %>%
filter(scenario %in% paste0("scenario_", c(1, 3, 8, 9))) %>%
filter(model != "T_RF") %>%
mutate(
scenario = factor(
recode(scenario,
`scenario_1` = "Null",
`scenario_3` = "Simple",
`scenario_8` = "Complex",
`scenario_9` = "Non-linear"),
levels = c("Null", "Simple", "Complex", "Non-linear")
),
n = factor(
recode(size,
`250` = "250",
`500` = "500",
`1000` = "1000"),
levels = c("250", "500", "1000")
),
model = factor(
recode(model,
`CF` = "Causal forest",
`DR_RF` = "DR-RandomForest",
`DR_oracle` = "DR-oracle"),
levels = c("Causal forest", "DR-RandomForest", "DR-oracle")
)
) %>%
select(-size)
res_coverage %>%
ggplot(aes(x = n, y = length, color = model, fill = model)) +
geom_boxplot(alpha = 0.7) +
facet_wrap(~scenario, nrow = 2) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
labs(y = "coverage",
x = "Sample size")
res_coverage %>%
ggplot(aes(x = n, y = length, color = model, fill = model)) +
geom_boxplot(alpha = 0.7) +
facet_wrap(~scenario, nrow = 2) +
scale_fill_paletteer_d("rcartocolor::Safe") +
scale_color_paletteer_d("rcartocolor::Safe") +
theme_minimal() +
labs(y = "Coverage",
x = "Sample size")
?GenericML::BLP
library(dplyr)
library(tidyr)
# paths
base_path <- "/rds/general/user/evanvogt/projects/nihr_drf_simulations"
# arguments and parameters
scenarios <- seq(1:5)
sample_sizes <- 500
model_names <- c("causal_forest", "dr_random_forest", "dr_superlearner", "dr_oracle", "dr_semi_oracle")
result_types <- c("tau", "BLP_whole", "independence_whole", "data", "truth")
miss_type <- c("prognostic", "predictive", "both")
miss_prop <- 0.3
miss_mech <- c("MAR", "AUX")
miss_method <- c("complete_cases", "mean_imputation", "missforest", "regression", "missing_indicator")
results_by_type <- setNames(vector("list", length(result_types)), result_types)
for (result_type in result_types) {
results_by_type[[result_type]] <- list()
for (scenario in scenarios) {
scenario_name <- paste0("scenario_", scenario)
results_by_type[[result_type]][[scenario_name]] <- list()
for (n in sample_sizes) {
sample_size <- paste0("size_", n)
results_by_type[[result_type]][[scenario_name]][[sample_size]] <- list()
for (type in miss_type) {
results_by_type[[result_type]][[scenario_name]][[sample_size]][[type]] <- list()
for (prop in miss_prop) {
prop_chr <- as.character(prop)
results_by_type[[result_type]][[scenario_name]][[sample_size]][[type]][[prop_chr]] <- list()
for (mech in miss_mech) {
results_by_type[[result_type]][[scenario_name]][[sample_size]][[type]][[prop_chr]][[mech]] <- list()
for (method in miss_method) {
results_by_type[[result_type]][[scenario_name]][[sample_size]][[type]][[prop_chr]][[mech]][[method]] <- list()
res_dir <- file.path(base_path, "live/results/missing/continuous",
type, prop_chr, method,
paste0("scenario_", scenario), n, "all_methods")
result_files <- list.files(res_dir, pattern = "^res_sim_\\d+\\.RDS$", full.names = TRUE)
result_files <- result_files[order(as.numeric(gsub(".*res_sim_(\\d+)\\.RDS$", "\\1",
result_files, ignore.case = TRUE)))]
if (length(result_files) < 100) {
warning(sprintf("Scenario %s, n=%s, type=%s, prop=%s, mech=%s, method=%s: only %d sims found (expected 100)",
scenario, n, type, prop_chr, mech, method, length(result_files)))
}
if (length(result_files) == 0) next
temp_model_res <- list()
for (res_file in result_files) {
sim_res <- readRDS(res_file)
if (result_type %in% c("data", "truth")) {
sim_num <- gsub(".*res_sim_(\\d+)\\.RDS$", "\\1", res_file)
value <- sim_res[[result_type]]
if (!result_type %in% names(temp_model_res)) temp_model_res[[result_type]] <- list()
temp_model_res[[result_type]] <- c(temp_model_res[[result_type]], list(value))
} else {
for (model in model_names) {
value <- sim_res[[model]][[result_type]]
if (!model %in% names(temp_model_res)) temp_model_res[[model]] <- list()
temp_model_res[[model]] <- c(temp_model_res[[model]], list(value))
}
}
}
results_by_type[[result_type]][[scenario_name]][[sample_size]][[type]][[prop_chr]][[mech]][[method]] <- temp_model_res
}
}
}
}
}
}
}
warnings()
miss_type <- "prognostic"
miss_prop <- 0.3
mich_mech <- "AUX"
miss_mech <- "AUX"
miss_method <- "complete_cases"
scenario <- 1
n <- 250
n <- 500
# Save results
output_dir <- paste0("live/results/missing/continuous/", miss_type, "/", miss_prop, "/", miss_mech, "/", miss_method, "/scenario_", scenario, "/", n, "/all_methods/")
output_dir
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
